- name: Ensure that the data for the new FAS snapshot can be retrieved and that the snapshot completes before proceeding
  max_retries: 30
  delay_after: 10
  request:
    url: "{fas_base_url}/snapshots/fasTestSnapshot"
    method: GET
    verify: !bool "{verify}"
  response:
    status_code: 200
    verify_response_with:
      function: tavern.testutils.helpers:validate_pykwalify
      extra_kwargs:
        schema:
          type: map
          required: True
          mapping:
            name:
              type: str
              required: True
              enum:
                - "fasTestSnapshot"
            captureTime:
              type: str
              required: True
              pattern: "[0-9]{{4}}-[0-9]{{2}}-[0-9]{{2}} [0-9]{{2}}:[0-9]{{2}}:[0-9]{{2}}.[0-9]+ .*[0-9]{{4}} UTC"
            ready:
              type: bool
              required: True
              enum:
                - True
            devices:
              type: seq
              required: True
              matching: all
              sequence:
              - type: map
                required: True
                mapping:
                  xname:
                    type: str
                    required: True
                  targets:
                    type: seq
                    required: True
                    matching: all
                    sequence:
                    - type: map
                      required: True
                      mapping:
                        name:
                          type: str
                          required: True
                        firmwareVersion:
                          type: str
                          required: False
                        error:
                          type: str
                          required: False
                        softwareId:
                          type: str
                          required: False
                        targetName:
                          type: str
                          required: True
                        imageID:
                          type: str
                          required: True
                  error:
                    type: str
                    required: False
            relatedActions:
              type: seq
              required: True
              matching: all
              sequence:
              - type: map
                required: True
                mapping:
                  actionID:
                    type: str
                    required: True
                  startTime:
                    type: timestamp
                    required: True
                  endTime:
                    type: timestamp
                    required: True
                  state:
                    type: str
                    required: True
                    enum:
                      - "configured"
                      - "blocked"
                      - "completed"
            parameters:
              type: map
              required: True
              mapping:
                name:
                  type: str
                  required: True
                  enum:
                    - "fasTestSnapshot"
                stateComponentFilter:
                  type: map
                  required: True
                  mapping:
                    xnames:
                      type: seq
                      required: False
                      matching: all
                      sequence:
                      - type: str
                        required: True
                    deviceTypes:
                      type: seq
                      required: True
                      matching: all
                      sequence:
                      - type: str
                        required: True
                        enum:
                          - "chassisBMC"
                          - "nodeBMC"
                          - "routerBMC"
                inventoryHardwareFilter:
                  type: map
                  required: True
                  mapping:
                    manufacturer:
                      type: str
                      required: False
                    model:
                      type: str
                      required: False
                targetFilter:
                  type: map
                  required: True
                  mapping:
                    targets:
                      type: seq
                      required: True
                      matching: all
                      sequence:
                      - type: str
                        required: True
                        enum:
                          - "BMC"
                          - "BIOS"
                          - "iLO 5"
                          - "System ROM"
            errors:
              type: seq
              required: True
              matching: all
              sequence:
              - type: str
                required: False