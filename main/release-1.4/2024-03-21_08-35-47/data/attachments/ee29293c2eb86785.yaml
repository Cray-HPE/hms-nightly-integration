- name: Ensure that the new FAS action has completed before attempting to delete it
  max_retries: 30
  delay_after: 10
  request:
    url: "{fas_base_url}/actions/{newActionID}/status"
    method: GET
    verify: !bool "{verify}"
  response:
    status_code: 200
    verify_response_with:
      function: tavern.testutils.helpers:validate_pykwalify
      extra_kwargs:
        schema:
          type: map
          required: True
          mapping:
            actionID:
              type: str
              required: True
              enum:
                - "{newActionID}"
            snapshotID:
              type: str
              required: True
            command:
              type: map
              required: True
              mapping:
                overrideDryrun:
                  type: bool
                  required: True
                  enum:
                    - false
                restoreNotPossibleOverride:
                  type: bool
                  required: True
                  enum:
                    - false
                overwriteSameImage:
                  type: bool
                  required: True
                  enum:
                    - false
                timeLimit:
                  type: int
                  required: True
                  enum:
                    - 120
                version:
                  type: str
                  required: True
                  enum:
                    - "latest"
                tag:
                  type: str
                  required: True
                  enum:
                    - "default"
                description:
                  type: str
                  required: True
                  enum:
                    - "test_actions CT test description"
            startTime:
              type: str
              required: True
              pattern: "[0-9]{{4}}-[0-9]{{2}}-[0-9]{{2}} [0-9]{{2}}:[0-9]{{2}}:[0-9]{{2}}.[0-9]+ .*[0-9]{{4}} UTC"
            endTime:
              type: str
              required: True
              pattern: "[0-9]{{4}}-[0-9]{{2}}-[0-9]{{2}} [0-9]{{2}}:[0-9]{{2}}:[0-9]{{2}}.[0-9]+ .*[0-9]{{4}} UTC"
            state:
              type: str
              required: True
              enum:
                - "configured"
                - "blocked"
                - "completed"
            operationCounts:
              type: map
              required: True
              mapping:
                total:
                  type: int
                  required: True
                initial:
                  type: int
                  required: True
                configured:
                  type: int
                  required: True
                blocked:
                  type: int
                  required: True
                needsVerified:
                  type: int
                  required: True
                verifying:
                  type: int
                  required: True
                inProgress:
                  type: int
                  required: True
                failed:
                  type: int
                  required: True
                succeeded:
                  type: int
                  required: True
                noOperation:
                  type: int
                  required: True
                noSolution:
                  type: int
                  required: True
                aborted:
                  type: int
                  required: True
                unknown:
                  type: int
                  required: True
            blockedBy:
              type: seq
              required: True
              matching: all
              sequence:
                - type: str
                  required: False
            errors:
              type: seq
              required: True
              matching: all
              sequence:
                - type: str
                  required: False


